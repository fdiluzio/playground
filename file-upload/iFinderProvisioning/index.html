<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>File Uploader</title>
    <link rel="stylesheet" type="text/css" href="app.css">
    <link rel="stylesheet" type="text/css" href="file-uploader.css">

</head>

<body>

    <main class="ifs-page">

        <section class="ifs-uploader">

            <h3 class="ifs-uploader-title">Upload Files</h3>


            <div class="ifs-restrictions ifs-files-selected--hide">
                <h4>Please keep the following in mind when uploading files:</h4>
                <ul>
                    <li>You may upload 10 files at once. Individual file sizes up to 10 MB are allowed.</li>
                    <li>Do not upload files that are confidential to you, your company or anyone else.</li>
                    <li>We support a wide range of file types â€” including MS Office, PDF, images and more.</li>
                </ul>
            </div>


            <div class="ifs-background-message">

                
                <div id="ifs-background-message" class="ifs-files-selected--hide">Add files by dropping them here or
                    using the button below.</div>
                <div id="ifs-uploader-drop-area" class="ifs-uploader-drop-area">
                    <ul id="ifs-uploader-filelist" class="ifs-uploader-list">
                    </ul>
                    <svg class="ifs-loading-animation" viewBox="0 0 100 100"><use href="#ifs-file-loader-loading-ani" /></svg>

                </div>
                <div id="ifs-error-message" class="ifs-uploader-error"></div>
            
            </div>


            <div class="ifs-uploader-input-area">
                <label id="ifs-upifloader-select" class="ifs-uploader-input-btn" for="ifs-uploader">Select
                    files</label>
                <button style="display:none" id="ifs-uploader-submit"
                    class="ifs-uploader-input-btn ifs-uploader-input-btn-send">Upload files</button>
            </div>



            <form name="ifs-upload-files">
                <input type="file" id="ifs-uploader" multiple="multiple" class="ifs-uploader-input" />
            </form>

        </section>


    </main>


    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"  preserveAspectRatio="xMidYMid" style="display: none;">
        <defs>
            <g id="ifs-file-loader-loading-ani">
                <circle cx="84" cy="50" r="10" fill="#6a6a6a">
                    <animate attributeName="r" repeatCount="indefinite" dur="0.6578947368421053s" calcMode="spline"
                        keyTimes="0;1" values="10;0" keySplines="0 0.5 0.5 1" begin="0s"></animate>
                    <animate attributeName="fill" repeatCount="indefinite" dur="2.6315789473684212s" calcMode="discrete"
                        keyTimes="0;0.25;0.5;0.75;1" values="#6a6a6a;#e2e2e2;#bdbdbd;#979797;#6a6a6a" begin="0s">
                    </animate>
                </circle>
                <circle cx="16" cy="50" r="10" fill="#6a6a6a">
                    <animate attributeName="r" repeatCount="indefinite" dur="2.6315789473684212s" calcMode="spline"
                        keyTimes="0;0.25;0.5;0.75;1" values="0;0;10;10;10"
                        keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" begin="0s"></animate>
                    <animate attributeName="cx" repeatCount="indefinite" dur="2.6315789473684212s" calcMode="spline"
                        keyTimes="0;0.25;0.5;0.75;1" values="16;16;16;50;84"
                        keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" begin="0s"></animate>
                </circle>
                <circle cx="50" cy="50" r="10" fill="#979797">
                    <animate attributeName="r" repeatCount="indefinite" dur="2.6315789473684212s" calcMode="spline"
                        keyTimes="0;0.25;0.5;0.75;1" values="0;0;10;10;10"
                        keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" begin="-0.6578947368421053s">
                    </animate>
                    <animate attributeName="cx" repeatCount="indefinite" dur="2.6315789473684212s" calcMode="spline"
                        keyTimes="0;0.25;0.5;0.75;1" values="16;16;16;50;84"
                        keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" begin="-0.6578947368421053s">
                    </animate>
                </circle>
                <circle cx="84" cy="50" r="10" fill="#bdbdbd">
                    <animate attributeName="r" repeatCount="indefinite" dur="2.6315789473684212s" calcMode="spline"
                        keyTimes="0;0.25;0.5;0.75;1" values="0;0;10;10;10"
                        keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" begin="-1.3157894736842106s">
                    </animate>
                    <animate attributeName="cx" repeatCount="indefinite" dur="2.6315789473684212s" calcMode="spline"
                        keyTimes="0;0.25;0.5;0.75;1" values="16;16;16;50;84"
                        keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" begin="-1.3157894736842106s">
                    </animate>
                </circle>
                <circle cx="16" cy="50" r="10" fill="#e2e2e2">
                    <animate attributeName="r" repeatCount="indefinite" dur="2.6315789473684212s" calcMode="spline"
                        keyTimes="0;0.25;0.5;0.75;1" values="0;0;10;10;10"
                        keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" begin="-1.9736842105263157s">
                    </animate>
                    <animate attributeName="cx" repeatCount="indefinite" dur="2.6315789473684212s" calcMode="spline"
                        keyTimes="0;0.25;0.5;0.75;1" values="16;16;16;50;84"
                        keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" begin="-1.9736842105263157s">
                    </animate>
                </circle>
            </g>
        </defs>
        <!-- [ldio] generated by https://loading.io/ -->
    </svg>

    <script id="template-file-item" type="text/template">

            <li class="ifs-uploader-list-item">
                <strong>{{name}}</strong><br />
                <small class="ifs-uploader-list-item-details">{{size}} | {{lastmodifiedDate}}</small>
            </li>

        </script>

    <script defer>
        (function (window) {


            var dropArea = document.getElementById("ifs-uploader-drop-area");
            var templateHtml = document.getElementById("template-file-item").innerHTML;
            var fileDisplayList = document.getElementById("ifs-uploader-filelist");
            var upLoadSubmitBtn = document.getElementById('ifs-uploader-submit');
            var errorMsg = document.getElementById('ifs-error-message');
            var section = document.querySelector('.ifs-uploader');
            var loadingAni = document.querySelector('.ifs-loading-animation');
            var maxFileSize = 1048576 * 10; // 10 MB (1MB = 1048576)
            var maxNumberOfFiles = 10;
            var FileUploaderServlet = '/iFinder5/FileUploaderServlet';
            var fileUploadInput = document.getElementById('ifs-uploader');
            var fileList = [];

            upLoadSubmitBtn.addEventListener('click', onUploadFiles, false);
            document.getElementById('ifs-uploader').addEventListener('change', onInputChange, false);

            // EVENTS

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function (eventName) {
                dropArea.addEventListener(eventName, onDragAndDrop, false)
                document.body.addEventListener(eventName, onDragAndDrop, false)
            });



            function onDragAndDrop(e) {
               
                e.preventDefault();
                e.stopPropagation();

                switch (e.type) {
                    case "dragenter":
                        this.classList.add('ifs-drag-active');
                        break;

                    case "dragleave":
                        this.classList.remove('ifs-drag-active');
                        break;

                    case "drop":

                        processFiles(e.dataTransfer.files);
                        break;

                }

            }

            function processFiles(files) {

                fileList = Array.prototype.slice.call(files, 0);


                disablepLoad();
                var FileListHTML = "";
                var fileCount = fileList.length;
                if (fileCount < 1) {
                    fileDisplayList.innerHTML = "";
                }

                if (fileCount > maxNumberOfFiles) {
                    var overDrawn = fileCount - maxNumberOfFiles;
                    formNotValidError(`Only ${maxNumberOfFiles} files may be submited at once. You've selected ${overDrawn} too many.`);
                    return;
                }

                for (var i = 0; i < fileCount; i++) {

                    var file = fileList[i];

                    var dO = {
                        name: file.name,
                        bytes: file.size,
                        size: bytesToSize(file.size),
                        type: file.type,
                        lastmodifiedDate: formatDate(file.lastModified)
                    };

                    if (isFileSizeValid(dO.bytes)) {
                        FileListHTML += templateHtml.replace(/{{name}}/g, dO.name)
                            .replace(/{{size}}/g, dO.size)
                            .replace(/{{type}}/g, dO.type)
                            .replace(/{{lastmodifiedDate}}/g, dO.lastmodifiedDate);

                        fileDisplayList.innerHTML = FileListHTML;
                        enablepLoad();
                    } else {
                        formNotValidError(`File ${dO.name} is greater than the 10 MB limit (${dO.size}).`);
                        return;
                    }

                }

            }




            function onInputChange(e) {
                processFiles(this.files);
            }

            function onUploadFiles() {

                disablepLoad();
                showLoading();

                var processedFiles = 0;
                var upLoadedFiles = 0;


                fileList.forEach(function (file) {

                    var xhr = new XMLHttpRequest();
                    var currentFile = file.name;
                    xhr.onreadystatechange = function () {

                        var statusMessageIcon = "&#x26A0;";

                        if (xhr.readyState == 4) { // done

                            ++processedFiles;
                            switch (true) {
                                case (xhr.status === 200):
                                    upLoadedFiles++
                                    statusMessageIcon = "&check;";
                                    fileProcessed(currentFile, statusMessageIcon);
                                    if (processedFiles >= fileList.length) {
                                        fileUploadComplete(upLoadedFiles);
                                    }
                                    break;
                                case (xhr.status >= 400 && xhr.status < 600):
                                    hideLoading();
                                    formNotValidError(`Unable to upload files: ${xhr.status}`);
                                    break;
                            }


                        }
                    }

                    xhr.open("POST", FileUploaderServlet, true);
                    xhr.setRequestHeader("File-Name", file.name);
                    xhr.setRequestHeader("File-Size", file.size);
                    xhr.setRequestHeader("File-Date", file.lastModified);
                    xhr.send(file);

                });

            };

            // HELPERS

            function clearFileDisplayList() {
                fileDisplayList.innerHTML = "";
            }

            function fileProcessed(currentFile, statusMessage) {
                var entry = document.createElement('li');
                entry.style.flexBasis = '100%';
                entry.innerHTML = statusMessage + '&nbsp;' + currentFile
                fileDisplayList.appendChild(entry);
            }

            function fileUploadComplete(nrOfFiles) {
                var entry = document.createElement('li');
                entry.style.flexBasis = '100%';
                entry.style.marginTop = '2rem';
                entry.textContent = nrOfFiles + ' ' + ((nrOfFiles > 1) ? 'files' : 'file') + " uploaded. Go to the searchbar and use an asterix (*) in the search field to find all your documents. You may also continue by adding further documents.";
                fileDisplayList.appendChild(entry);
                hideLoading();

            }

            function enablepLoad() {
                section.classList.add('ifs-files-selected');
                upLoadSubmitBtn.style.display = "inline";
            };

            function disablepLoad() {
                clearFileDisplayList();
                upLoadSubmitBtn.style.display = "none";
                errorMsg.style.display = 'none';
            };

            function isFileSizeValid(bytes) {
                return !!(bytes <= maxFileSize);
            }

            function resetForm() {
                disablepLoad();
                section.classList.remove('ifs-files-selected');
                fileDisplayList.innerHTML = "";
                document.forms['ifs-upload-files'].reset();
                dropArea.classList.remove('ifs-drag-active');
            }

            function showLoading(){
                loadingAni.style.display = 'block'
            }
            function hideLoading(){
                loadingAni.style.display = 'none'
            }

            function formNotValidError(message) {
                resetForm();
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
            }

            function formatDate(millisecs) {
                var options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                };
                var date = new Date(millisecs);
                return date.toLocaleString('en-US', options);
            }

            function bytesToSize(bytes) {
                var sizes = ['Bytes', 'KB', 'MB'];
                if (bytes === 0) return 'n/a';
                var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
                return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
            }

        })(window);
    </script>



</body>

</html>